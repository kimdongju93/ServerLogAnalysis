<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서버 로그 실시간 분석 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .graph-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-2xx { color: #28a745; }
        .status-4xx { color: #ffc107; }
        .status-5xx { color: #dc3545; }
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-light">
    <div class="refresh-indicator">
        <i class="fas fa-sync-alt loading" id="refreshIcon"></i>
        <small class="text-muted" id="lastUpdate"></small>
    </div>

    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">
            <i class="fas fa-chart-line"></i> 서버 로그 실시간 분석 대시보드
        </h1>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-globe fa-2x mb-2"></i>
                    <h3 id="totalRequests">0</h3>
                    <p>총 요청 수</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="avgResponseTime">0ms</h3>
                    <p>평균 응답시간</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="successRate">0%</h3>
                    <p>성공률</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h3 id="errorRate">0%</h3>
                    <p>에러율</p>
                </div>
            </div>
        </div>

        <!-- 그래프 섹션 -->
        <div class="row">
            <div class="col-md-6">
                <div class="graph-container">
                    <h5><i class="fas fa-chart-bar"></i> 시간별 요청 건수</h5>
                    <img id="hourlyTraffic" src="" alt="시간별 트래픽" class="img-fluid">
                </div>
            </div>
            <div class="col-md-6">
                <div class="graph-container">
                    <h5><i class="fas fa-chart-pie"></i> 상태 코드 분포</h5>
                    <img id="statusDistribution" src="" alt="상태 코드 분포" class="img-fluid">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="graph-container">
                    <h5><i class="fas fa-chart-bar"></i> 엔드포인트별 호출수</h5>
                    <img id="endpointCounts" src="" alt="엔드포인트별 호출수" class="img-fluid">
                </div>
            </div>
            <div class="col-md-6">
                <div class="graph-container">
                    <h5><i class="fas fa-chart-line"></i> 엔드포인트별 평균 응답시간</h5>
                    <img id="endpointAvgResp" src="" alt="엔드포인트별 평균 응답시간" class="img-fluid">
                </div>
            </div>
        </div>

        <!-- 테이블 섹션 -->
        <div class="row">
            <div class="col-md-6">
                <div class="table-container">
                    <h5><i class="fas fa-exclamation-triangle"></i> 느린 요청 (상위 5개)</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>메소드</th>
                                    <th>엔드포인트</th>
                                    <th>상태</th>
                                    <th>응답시간</th>
                                </tr>
                            </thead>
                            <tbody id="slowRequestsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-container">
                    <h5><i class="fas fa-history"></i> 최근 요청 (최근 10개)</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>메소드</th>
                                    <th>엔드포인트</th>
                                    <th>상태</th>
                                    <th>응답시간</th>
                                </tr>
                            </thead>
                            <tbody id="recentRequestsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    // 기본 통계 업데이트
                    document.getElementById('totalRequests').textContent = data.total_requests.toLocaleString();
                    
                    // 평균 응답시간 계산
                    let totalResp = 0;
                    let totalCount = 0;
                    Object.values(data.endpoint_stats).forEach(stat => {
                        totalResp += stat.avg_resp * stat.count;
                        totalCount += stat.count;
                    });
                    const avgResp = totalCount > 0 ? Math.round(totalResp / totalCount) : 0;
                    document.getElementById('avgResponseTime').textContent = avgResp + 'ms';
                    
                    // 성공률/에러율 계산
                    const total = data.status_distribution['2xx'] + data.status_distribution['4xx'] + data.status_distribution['5xx'];
                    const successRate = total > 0 ? Math.round((data.status_distribution['2xx'] / total) * 100) : 0;
                    const errorRate = total > 0 ? Math.round(((data.status_distribution['4xx'] + data.status_distribution['5xx']) / total) * 100) : 0;
                    
                    document.getElementById('successRate').textContent = successRate + '%';
                    document.getElementById('errorRate').textContent = errorRate + '%';
                    
                    // 느린 요청 테이블 업데이트
                    updateTable('slowRequestsTable', data.slow_requests);
                    
                    // 최근 요청 테이블 업데이트
                    updateTable('recentRequestsTable', data.recent_requests);
                    
                    // 마지막 업데이트 시간
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                })
                .catch(error => console.error('통계 업데이트 오류:', error));
        }

        function updateGraphs() {
            fetch('/api/graphs')
                .then(response => response.json())
                .then(data => {
                    if (data.hourly_traffic) {
                        document.getElementById('hourlyTraffic').src = data.hourly_traffic;
                    }
                    if (data.status_distribution) {
                        document.getElementById('statusDistribution').src = data.status_distribution;
                    }
                    if (data.endpoint_counts) {
                        document.getElementById('endpointCounts').src = data.endpoint_counts;
                    }
                    if (data.endpoint_avg_resp) {
                        document.getElementById('endpointAvgResp').src = data.endpoint_avg_resp;
                    }
                })
                .catch(error => console.error('그래프 업데이트 오류:', error));
        }

        function updateTable(tableId, data) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            data.forEach(request => {
                const row = document.createElement('tr');
                const statusClass = request.status >= 200 && request.status < 300 ? 'status-2xx' : 
                                  request.status >= 400 && request.status < 500 ? 'status-4xx' : 'status-5xx';
                
                row.innerHTML = `
                    <td>${new Date(request.datetime).toLocaleTimeString()}</td>
                    <td><span class="badge bg-secondary">${request.method}</span></td>
                    <td><small>${request.endpoint}</small></td>
                    <td><span class="${statusClass}">${request.status}</span></td>
                    <td>${request.resp_ms}ms</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 초기 로드
        updateStats();
        updateGraphs();

        // 5초마다 업데이트
        setInterval(() => {
            updateStats();
            updateGraphs();
        }, 5000);

        // 수동 새로고침
        document.getElementById('refreshIcon').addEventListener('click', () => {
            updateStats();
            updateGraphs();
        });
    </script>
</body>
</html> 